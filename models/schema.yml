
version: 2

# Most testing will be done immediately with incoming data to ensure later joins. Most important is PK, FK, BR.
sources:
  - name: raw
    database: silverscreen
    schema: raw
    tables:
      - name: invoices
        description: Holds invoices for renting movies from movie distributions. These invoices represent our costs for showing the movies.
        time_spine:
          standard_granularity_column: invoice_date
        columns:
          - name: movie_id
            description: Foreign key identifying the movie been rented. Primary key in movies table.
            tests:
              - not_null
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw','movies')
          - name: invoice_id
            description: Identifier of invoice for renting a movie from distributor.
          - name: invoice_date
            description: Date when invoice was been issued. One of three keys to connect with sales figures.
            tests:
              - not_null
              - not_earlier_than_threshold_date
              # relationship will be tested later, as date format of related tables needs transformations.
            granularity: day
          - name: cinema_id
            description: Identifies the movie theatre which rented the movie.
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values:
                      - 'NJ_001'
                      - 'NJ_002'
                      - 'NJ_003'
          - name: movie_studio
            description: Name of the movie studio which produced the movie.
          - name: movie_release_date
            description: Official release date of movie. Not always similar to date we show the movies.
          - name: invoice_sum
            description: Rental costs in USD for a specific movie for a specific cienma per given month.
            tests:
              - not_null
              - not_negative
          - name: load_timestamp
            description: Date and time of dataload from stage to raw.
      - name: movies
        description: Holds qualitative information about movies, like title, director and more. Dimensional table.
        columns:
          - name: movie_id
            description: Primary Key. Identifies the movie. Needs to be unique. Used as foreign key in all other tables.
            tests:
              - not_null
              - unique
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw', 'invoices')
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw', 'sales_cinema_01')
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw', 'sales_cinema_02')
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw', 'sales_cinema_03')
          - name: movie_title
            description: Title of the movie.
          - name: movie_release_date
            description: Release date of the movie.
          - name: genre
            description: Genre of the movie.
          - name: country
            description: Country location of movie studio which produced the movie.
          - name: studio
            description: Name of movie studio which produced that movie.
          - name: budget
            description: Budget which was spent for movie production.
            tests:
              - not_negative
          - name: director
            description: Director who was producing the movie.
          - name: pg_rating
            description: PG rating of the movie.
          - name: movie_length_min
            description: Lenght of movie in minues.
            tests:
              - not_negative
          - name: load_timestamp
            description: Date and time when data was loaded.
      - name: sales_cinema_01
        description: Shows movie ticket sales figures from a specific movie theatre per month. 
        columns:
          - name: day
            description: Year-Month which corresponds to the recorded tickets sales. 
            tests:
              - not_null
              - not_earlier_than_threshold_date
            granularity: month
          - name: movie_id
            description: Foreign key. Identifies the shown movie. Related to primary key in table movies.
            tests:
              - not_null
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw','movies')
          - name: tickets_sold
            description: Number of tickets sold for that movie in that cinema on given day.
            tests:
              - not_null
              - not_negative
          - name: total_revenue
            description: Revenue in USD by tickets sold for that movie in that cinema on given day.
            tests:
              - not_null
              - not_negative
          - name: cinema_id
            description: Part of primary key of this table clearly identifying the movie theatre where the film was shown.
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: [1,2,3]
          - name: load_timestamp
            description: Date and time when the raw data was loaded.
      - name: sales_cinema_02
        description: Shows movie ticket sales figures from a specific movie theatre over time.  
        columns:
          - name: day
            description: Date which corresponds to the recorded tickets sales. 
            tests:
              - not_null
              - not_earlier_than_threshold_date
          - name: movie_id
            description: Foreign key. Identifies the shown movie. Related to primary key in table movies.
            tests:
              - not_null
              - relationships:
                  arguments:
                    field: movie_id
                    to: source('raw','movies')
          - name: tickets_sold
            description: Number of tickets sold for that movie in that cinema on given day.
            tests:
              - not_null
              - not_negative
          - name: total_revenue
            description: Revenue in USD by tickets sold for that movie in that cinema on given day.
            tests:
              - not_null
              - not_negative
          - name: cinema_id
            description: Part of primary key of this table clearly identifying the movie theatre where the film was shown.
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: [1,2,3]
          - name: load_timestamp
            description: Date and time when the raw data was loaded.
      - name: sales_cinema_03
        description: Shows movie ticket sales figures from a specific movie theatre over time. 
        columns:
          - name: month
            description: Month which corresponds to the recorded tickets sales. 
            tests:
              - not_null
              - not_earlier_than_threshold_date
          - name: movie_id
            description: Foreign key. Identifies the shown movie. Related to primary key in table movies.
            tests:
              - not_null:
                  config:
                    where: "product_type = 'tickets'"
              - relationships:
                  config:
                    where: "product_type = 'ticket'"  
                  arguments:
                    field: movie_id
                    to: source('raw','movies')
          - name: tickets_sold
            description: Number of tickets sold for that movie in that cinema on given day.
            tests:
              - not_null
              - not_negative
          - name: total_revenue
            description: Revenue in USD by tickets sold for that movie in that cinema on given day.
            tests:
              - not_null
              - not_negative
          - name: cinema_id
            description: Part of primary key of this table clearly identifying the movie theatre where the film was shown.
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values:
                      - 3
          - name: load_timestamp
            description: Date and time when the raw data was loaded.
  
